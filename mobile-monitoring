#!/bin/bash
set -e

echo "üè¶ FINTECH MOBILE SECURITY - ALL IN ONE BOOTSTRAP"

# ================================
# 1. CHECK & INSTALL DOCKER
# ================================
if ! command -v docker >/dev/null 2>&1; then
  echo "üîß Docker tidak ditemukan, menginstall..."
  curl -fsSL https://get.docker.com | sh
  systemctl start docker
  systemctl enable docker
else
  echo "‚úÖ Docker sudah terinstall"
fi

# ================================
# 2. CHECK & INSTALL DOCKER COMPOSE
# ================================
if ! command -v docker-compose >/dev/null 2>&1 && ! docker compose version >/dev/null 2>&1; then
  echo "üîß Docker Compose tidak ditemukan, menginstall..."
  curl -L "https://github.com/docker/compose/releases/download/v2.25.0/docker-compose-$(uname -s)-$(uname -m)" \
    -o /usr/local/bin/docker-compose
  chmod +x /usr/local/bin/docker-compose
else
  echo "‚úÖ Docker Compose sudah tersedia"
fi

# ================================
# 3. PREPARE DIRECTORY
# ================================
mkdir -p mobile-security/{backend,dashboard,android-agent,ios-agent}
cd mobile-security

# ================================
# 4. DOCKER COMPOSE STACK
# ================================
cat <<EOF > docker-compose.yml
version: "3.9"
services:
  api:
    image: python:3.11
    container_name: fintech-security-api
    volumes:
      - ./backend:/app
    working_dir: /app
    command: bash -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8000"
    ports:
      - "8000:8000"
    restart: always

  mobsf:
    image: opensecurity/mobile-security-framework-mobsf
    container_name: fintech-mobsf
    ports:
      - "8001:8000"
    restart: always

  grafana:
    image: grafana/grafana
    container_name: fintech-grafana
    ports:
      - "3000:3000"
    restart: always
EOF

# ================================
# 5. BACKEND + THREAT INTELLIGENCE
# ================================
cat <<EOF > backend/requirements.txt
fastapi
uvicorn
pydantic
EOF

cat <<EOF > backend/main.py
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI(title="Fintech Mobile Security API")

# ---- LOCAL THREAT INTELLIGENCE ----
FRIDA_IOC = ["frida-server", "libfrida"]
MALICIOUS_PACKAGES = [
    "com.topjohnwu.magisk",
    "com.noshufou.android.su"
]

class Report(BaseModel):
    platform: str
    frida: bool = False
    xposed: bool = False
    rooted: bool = False
    package_name: str = ""
    binary_name: str = ""

@app.post("/report")
def report(r: Report):
    risk = 0
    intel_hit = False

    if r.frida:
        risk += 100
        intel_hit = True
    if r.xposed:
        risk += 70
    if r.rooted:
        risk += 40
    if r.package_name in MALICIOUS_PACKAGES:
        risk += 80
        intel_hit = True
    if r.binary_name in FRIDA_IOC:
        risk += 100
        intel_hit = True

    return {
        "risk_score": risk,
        "threat_intel": intel_hit,
        "action": "KILL_APP" if risk >= 100 else "MONITOR",
        "soc_severity": "CRITICAL" if risk >= 100 else "INFO"
    }
EOF

# ================================
# 6. DASHBOARD
# ================================
cat <<EOF > dashboard/index.html
<!DOCTYPE html>
<html>
<body>
<h2>üè¶ Fintech Mobile Security SOC</h2>
<ul>
  <li><a href="http://localhost:8000/docs">Security API</a></li>
  <li><a href="http://localhost:8001">MobSF APK/IPA Scanner</a></li>
  <li><a href="http://localhost:3000">Grafana Dashboard</a></li>
</ul>
<p>Status: <b>Threat Intelligence & RASP ENABLED</b></p>
</body>
</html>
EOF

# ================================
# 7. ANDROID AGENT (AUTO-KILL)
# ================================
cat <<EOF > android-agent/Agent.kt
package security.agent

import android.os.Process
import java.io.File
import kotlin.system.exitProcess

object SecurityAgent {
    private val fridaPaths = listOf(
        "/data/local/tmp/frida-server",
        "/data/local/tmp/re.frida.server"
    )

    fun protect() {
        if (fridaPaths.any { File(it).exists() }) {
            Process.killProcess(Process.myPid())
            exitProcess(0)
        }
    }
}
EOF

# ================================
# 8. IOS AGENT (AUTO-KILL)
# ================================
cat <<EOF > ios-agent/Agent.swift
import Foundation

let fridaIOC = [
    "/usr/sbin/frida-server",
    "/Library/Frida"
]

func protect() {
    for path in fridaIOC {
        if FileManager.default.fileExists(atPath: path) {
            exit(0)
        }
    }
}
EOF

# ================================
# 9. RUN STACK
# ================================
echo "üöÄ Menjalankan Fintech Mobile Security Stack..."
docker compose up -d || docker-compose up -d

echo ""
echo "‚úÖ INSTALLATION & DEPLOYMENT SELESAI"
echo "-----------------------------------"
echo "üì° API       : http://localhost:8000/docs"
echo "üß™ MobSF     : http://localhost:8001"
echo "üìä Grafana   : http://localhost:3000"
echo ""
echo "üîê Mode      : CONSUMER MOBILE BANKING (FAIL-CLOSED)"
